<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Registro de Asistencia</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="container">
    <h1>Registro de Asistencia</h1>
    <div id="mensaje" class="mensaje"></div>
    
    <!-- Formulario para nombre y apellido -->
    <form id="form-docente" class="form-docente">
      <label for="nombre">Nombre:</label>
      <input type="text" id="nombre" name="nombre" required>
      
      <label for="apellido">Apellido:</label>
      <input type="text" id="apellido" name="apellido" required>
      
      <button type="submit">Registrar</button>
    </form>
  </div>

  <script>
    // 1. Función para obtener el parámetro "codigo" de la URL
    function getParametroCodigo() {
      const params = new URLSearchParams(window.location.search);
      return params.get('codigo');
    }

    // 2. Función para obtener la IP pública usando ipify
    function obtenerIP() {
      return fetch('https://api.ipify.org/?format=json')
        .then(response => response.json())
        .then(data => data.ip)
        .catch(error => {
          console.error('Error al obtener la IP:', error);
          return null;
        });
    }

    // 3. Función para validar si la IP pertenece a la red institucional
    function validarIP(ip) {
      // Ejemplo: se permite cualquier IP que comience con "192.168.1."
      const ipPermitida = "45.170.226.";
      return ip.startsWith(ipPermitida);
    }

    // 4. Lógica principal de registro
    async function iniciarRegistro() {
      const mensajeDiv = document.getElementById('mensaje');
      const formDocente = document.getElementById('form-docente');

      const codigo = getParametroCodigo();
      if (!codigo) {
        mensajeDiv.textContent = "Código no encontrado en la URL.";
        formDocente.style.display = "none";
        return;
      }

      // Obtenemos la IP pública
      const ip = await obtenerIP();
      if (!ip) {
        mensajeDiv.textContent = "No se pudo determinar la IP.";
        formDocente.style.display = "none";
        return;
      }

      // Validamos la IP
      if (!validarIP(ip)) {
        mensajeDiv.textContent = `Acceso denegado: la IP ${ip} no pertenece a la red institucional.`;
        formDocente.style.display = "none";
        return;
      }

      // Si la IP es válida, mostramos el formulario
      mensajeDiv.textContent = `Conexión validada. IP: ${ip}`;
      formDocente.style.display = "block";

      // Al enviar el formulario, registramos la asistencia
      formDocente.addEventListener('submit', (e) => {
        e.preventDefault();
        
        const nombre = document.getElementById('nombre').value;
        const apellido = document.getElementById('apellido').value;
        
        // Obtenemos fecha y hora actual
        const ahora = new Date();
        const fecha = ahora.toLocaleDateString();     // Ej: "17/03/2025"
        const hora = ahora.toLocaleTimeString();     // Ej: "15:36:12"

        // Aquí se "registra" la asistencia (solo mostramos en pantalla).
        // En un entorno real, enviaríamos esta información a un servidor.
        mensajeDiv.textContent = 
          `Asistencia registrada:\n` +
          `Nombre: ${nombre}\n` +
          `Apellido: ${apellido}\n` +
          `Código: ${codigo}\n` +
          `Fecha: ${fecha}\n` +
          `Hora: ${hora}\n` +
          `IP: ${ip}`;
        
        // Se oculta el formulario tras registrar
        formDocente.style.display = "none";
      });
    }

    // Inicialización
    document.addEventListener("DOMContentLoaded", () => {
      iniciarRegistro();
    });
  </script>
</body>
</html>
